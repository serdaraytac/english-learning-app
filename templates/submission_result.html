{% extends "base.html" %}
{% block title %}DeÄŸerlendirme - English Learning{% endblock %}
{% block content %}
<div class="result-page">
    <a href="{{ url_for('dashboard') }}" class="back-link">â† Dashboard'a DÃ¶n</a>

    {% if submission.status == 'pending' %}
    <div class="pending-box">
        <div class="spinner"></div>
        <h2>DeÄŸerlendiriliyor...</h2>
        <p>Ã–devin AI tarafÄ±ndan inceleniyor. Bu sayfa otomatik yenilenecek.</p>
        <script>setTimeout(() => location.reload(), 5000);</script>
    </div>
    
    {% elif submission.status == 'error' %}
    <div class="error-box">
        <h2>âŒ Bir Hata OluÅŸtu</h2>
        <p>DeÄŸerlendirme sÄ±rasÄ±nda bir sorun oluÅŸtu. LÃ¼tfen tekrar dene.</p>
        <a href="{{ url_for('exercises') }}" class="btn btn-primary">Yeni Egzersiz SeÃ§</a>
    </div>
    
    {% else %}
    {% set eval = submission.evaluations[0] if submission.evaluations else None %}
    
    <div class="result-header">
        <h1>{{ submission.exercises.title if submission.exercises else 'DeÄŸerlendirme' }}</h1>
        <div class="result-meta">
            <span class="level-badge level-{{ eval.estimated_level if eval else 'A2' }}">
                TahminÃ® Seviye: {{ eval.estimated_level if eval else '?' }}
            </span>
            {% if submission.revision_number > 0 %}
            <span class="revision-badge">{{ submission.revision_number }}. DÃ¼zeltme</span>
            {% endif %}
        </div>
    </div>

    {% if eval %}
    <div class="scores-grid">
        <div class="score-card">
            <div class="score-value">{{ eval.grammar_score }}/10</div>
            <div class="score-label">Dilbilgisi</div>
            <div class="score-bar"><div style="width: {{ eval.grammar_score * 10 }}%"></div></div>
        </div>
        <div class="score-card">
            <div class="score-value">{{ eval.vocabulary_score }}/10</div>
            <div class="score-label">Kelime</div>
            <div class="score-bar"><div style="width: {{ eval.vocabulary_score * 10 }}%"></div></div>
        </div>
        <div class="score-card">
            <div class="score-value">{{ eval.task_completion_score }}/10</div>
            <div class="score-label">GÃ¶reve Uygunluk</div>
            <div class="score-bar"><div style="width: {{ eval.task_completion_score * 10 }}%"></div></div>
        </div>
        <div class="score-card">
            <div class="score-value">{{ eval.coherence_score }}/10</div>
            <div class="score-label">TutarlÄ±lÄ±k</div>
            <div class="score-bar"><div style="width: {{ eval.coherence_score * 10 }}%"></div></div>
        </div>
    </div>

    <div class="overall-score">
        <div class="big-score">{{ eval.overall_score }}/10</div>
        <div class="score-label">Genel Puan</div>
    </div>

    <div class="feedback-section">
        <h2>ğŸ“ Geri Bildirim</h2>
        <div class="feedback-text">{{ eval.feedback_text }}</div>
    </div>

    {% if eval.errors_json and eval.errors_json|length > 0 %}
    <div class="errors-section">
        <h2>ğŸ” Hatalar ve Ã–ÄŸrenme FÄ±rsatlarÄ±</h2>
        <div class="errors-list">
            {% for err in eval.errors_json %}
            <div class="error-item">
                <div class="error-original">âŒ <strong>Hata:</strong> {{ err.error | safe }}</div>
                <div class="error-rule">ğŸ’¡ <strong>Kural:</strong> {{ err.rule if err.rule else err.explanation }}</div>
                <div class="error-example">ğŸ“ <strong>Ã–rnek:</strong> {{ err.example if err.example else 'KuralÄ± uygulayarak dÃ¼zelt' }}</div>
            </div>
            {% endfor %}
        </div>
        
        <div class="revise-cta">
            <p>HatalarÄ± dÃ¼zeltmek ister misin? Tekrar yazarak Ã¶ÄŸrenme pekiÅŸir!</p>
            <a href="{{ url_for('revise_submission', submission_id=submission.id) }}" class="btn btn-primary btn-large">
                âœï¸ DÃ¼zelterek Tekrar YÃ¼kle
            </a>
        </div>
    </div>
    {% else %}
    <div class="success-section">
        <h2>ğŸ‰ Harika!</h2>
        <p>Ã–nemli bir hata bulunamadÄ±. Yeni bir egzersizle devam edebilirsin!</p>
    </div>
    {% endif %}
    
    {% if eval.study_recommendations %}
    <div class="study-section">
        <h2>ğŸ“š Ã‡alÄ±ÅŸma Ã–nerileri</h2>
        <div class="study-list">
            {% for rec in eval.study_recommendations %}
            <div class="study-item">
                <span class="study-topic">{{ rec.topic }}</span>
                <span class="study-resource">{{ rec.resource }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% endif %}

    <div class="actions">
        <a href="{{ url_for('exercises') }}" class="btn btn-secondary">Yeni Egzersiz</a>
        <a href="{{ url_for('my_submissions') }}" class="btn btn-secondary">TÃ¼m Ã–devlerim</a>
    </div>
    {% endif %}
</div>
{% endblock %}
